<!--
  ========================================
  ?”ë“œì»?ê²Œì„ ?˜ì´ì§€ (World Cup Game)
  ========================================
  - ?Œì•… ?´ìƒ???”ë“œì»?ê²Œì„
  - 2ê°œì˜ ì¹´ë“œ ì¤?? íƒ?˜ì—¬ ? ë„ˆë¨¼íŠ¸ ì§„í–‰
  - ì¹´ë“œ ?´ë¦­ ??ë¯¸ë¦¬?£ê¸° ?¬ìƒ
  - ìµœì¢… ?°ìŠ¹ê³?? ì • ë°??€??
-->

{% extends "base.html" %}
{% block title %}?˜ë§Œ???”ë“œì»?| 2Beats{% endblock %}

{% block extra_head %}
<style>
  /* ========================================
     ?„ì—­ ?¤ì •
     ======================================== */
  body { user-select: none; }

  /* ?¤í¬ ??ë³´ì • */
  .wc-card {
    background: linear-gradient(140deg, rgba(124,58,237,0.12), rgba(192,132,252,0.08), var(--card));
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 18px;
    box-shadow: 0 22px 70px rgba(0,0,0,0.55);
    padding: 20px;
  }
  .wc-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 18px;
    border-radius: 14px;
    font-weight: 700;
    border: 1px solid transparent;
    cursor: pointer;
    transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.15s ease;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color: #0b1220;
    box-shadow: 0 18px 42px rgba(124,58,237,0.32);
  }
  .wc-btn.secondary {
    background: transparent;
    color: var(--text);
    border-color: var(--border);
    box-shadow: none;
  }
  .wc-btn:hover { transform: translateY(-1px); }
  .wc-btn:active { transform: translateY(0); opacity: 0.9; }
  input, select {
    background: #0c0a18;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
  }
  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,58,237,0.2);
  }

  /* ========================================
     ì»¨í…Œ?´ë„ˆ
     ======================================== */
  .wc-container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
    padding: 20px;
  }

  /* ?˜ì´ì§€ ?œëª© */
  .wc-container h1 {
    margin-bottom: 10px;
    background: linear-gradient(135deg, #ffffff 0%, #c084fc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem;
    font-weight: 700;
  }

  /* ?íƒœ ë°?(?¼ìš´???•ë³´) */
  .status-bar {
    font-size: 1.2rem;
    margin-bottom: 20px;
    color: rgba(255,255,255,0.7);
  }

  /* ========================================
     ?¤ì • ?”ë©´
     ======================================== */
  #setup-screen {
    display: block;
    margin-top: 100px;
  }

  /* ì»¤ìŠ¤?€ ?”ë“œì»??œëª© */
  .custom-title {
    font-size: 2rem;
    color: #c084fc;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .custom-creator {
    color: rgba(255,255,255,0.6);
    margin-bottom: 30px;
  }

  /* ?¤ì • ? íƒ */
  #setup-screen > div {
    margin: 15px 0;
  }

  #setup-screen label {
    color: rgba(255,255,255,0.8);
    margin-right: 10px;
    font-weight: 500;
  }

  select {
    padding: 10px 20px;
    font-size: 1rem;
    margin: 10px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
  }

  select:focus {
    outline: none;
    border-color: #c084fc;
    background: rgba(255,255,255,0.08);
  }

  select option {
    background: #120f1f;
    color: white;
  }

  /* ?œì‘ ë²„íŠ¼ */
  .btn-start {
    padding: 15px 40px;
    font-size: 1.1rem;
    margin: 20px 10px;
    border-radius: 2rem;
    border: none;
    background: linear-gradient(120deg, #c084fc, #7c3aed);
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 8px 24px rgba(124,58,237,0.35);
  }

  .btn-start:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(124,58,237,0.5);
  }

  /* ========================================
     ê²Œì„ ?”ë©´
     ======================================== */
  #game-screen {
    display: none;
    width: 100%;
  }

  /* ?€ê²?ì»¨í…Œ?´ë„ˆ - 2ê°?ì¹´ë“œ + VS */
  .versus-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 40px;
    margin-top: 30px;
  }

  /* ?„ë³´ ?˜í¼ (ì¹´ë“œ + ? íƒ ë²„íŠ¼) */
  .candidate-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
  }

  /* ========================================
     ì¹´ë“œ ?¤í???- ê¸€?˜ìŠ¤ëª¨í”¼ì¦?
     ======================================== */
  .card {
    width: 320px;
    height: 420px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 15px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  /* ì¹´ë“œ ?¸ë²„ ?¨ê³¼ */
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(192,132,252,0.3);
    border-color: rgba(192,132,252,0.4);
  }

  /* ?¬ìƒ ì¤‘ì¸ ì¹´ë“œ */
  .card.playing-card {
    border-color: #c084fc;
    box-shadow: 0 0 30px rgba(192,132,252,0.6);
    transform: scale(1.02);
  }

  /* ?¨ë²” ?´ë?ì§€ */
  .card img {
    width: 100%;
    height: 75%;
    object-fit: cover;
    pointer-events: none;
  }

  /* ì¹´ë“œ ?•ë³´ ?ì—­ */
  .card-info {
    padding: 15px;
    background: linear-gradient(to top, rgba(18,15,31,0.9), rgba(255,255,255,0.05));
    height: 25%;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .card-info h3 {
    margin: 0;
    font-size: 1.3rem;
    margin-bottom: 5px;
    color: white;
  }

  .card-info p {
    color: rgba(255,255,255,0.6);
    margin: 0;
    font-size: 0.9rem;
  }

  /* ?¬ìƒ ?„ì´ì½?*/
  .play-icon {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 0 20px rgba(192,132,252,0.8);
    opacity: 0;
    transition: 0.3s;
  }

  .card:hover .play-icon {
    opacity: 1;
  }

  .playing-card .play-icon {
    opacity: 0;  /* ?¬ìƒ ì¤‘ì¼ ?ŒëŠ” ?„ì´ì½??¨ê? */
  }

  /* ========================================
     ? íƒ ë²„íŠ¼
     ======================================== */
  .btn-select {
    padding: 15px 40px;
    font-size: 1.1rem;
    background: rgba(255,255,255,0.05);
    color: white;
    border: 2px solid rgba(192,132,252,0.3);
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
  }

  .btn-select:hover {
    background: linear-gradient(120deg, #c084fc, #7c3aed);
    color: white;
    border-color: #c084fc;
    box-shadow: 0 0 20px rgba(192,132,252,0.5);
    transform: scale(1.05);
  }

  /* VS ?ìŠ¤??*/
  .vs-text {
    font-size: 3rem;
    font-weight: bold;
    font-style: italic;
    background: linear-gradient(135deg, #ff3366, #ff6699);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-top: 180px;
    text-shadow: 0 0 30px rgba(255,51,102,0.5);
  }

  /* ?¤ë””???¨ê? */
  audio {
    display: none;
  }

  /* ========================================
     ê²°ê³¼ ?”ë©´
     ======================================== */
  #result-screen {
    display: none;
    margin-top: 50px;
  }

  #result-screen h2 {
    font-size: 2.5rem;
    margin-bottom: 30px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* ?°ìŠ¹ ì¹´ë“œ */
  .winner-card {
    margin: 0 auto 30px;
    transform: scale(1.2);
    border: 4px solid gold;
    box-shadow: 0 0 40px rgba(255, 215, 0, 0.7);
    width: 300px;
    border-radius: 15px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(12px);
    padding: 10px;
    animation: winner-glow 2s ease-in-out infinite;
  }

  @keyframes winner-glow {
    0%, 100% {
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.7);
    }
    50% {
      box-shadow: 0 0 60px rgba(255, 215, 0, 1);
    }
  }

  .winner-card img {
    width: 100%;
    border-radius: 10px;
  }

  .winner-card > div {
    padding: 15px;
  }

  .winner-card h3 {
    margin: 0;
    color: white;
  }

  .winner-card p {
    color: rgba(255,255,255,0.7);
    margin: 5px 0 0;
  }

  /* ========================================
     ëª¨ë°”??ë°˜ì‘??
     ======================================== */
  @media (max-width: 768px) {
    .versus-container {
      flex-direction: column;
      gap: 20px;
    }

    .vs-text {
      margin-top: 0;
      transform: rotate(90deg);
    }

    .card {
      width: 280px;
      height: 380px;
    }

    #setup-screen {
      margin-top: 50px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wc-container">
    <h1>³ª¸¸ÀÇ 2Beats World Cup</h1>

  <!-- ========================================
       ?¤ì • ?”ë©´
       ======================================== -->
  <div id="setup-screen" class="wc-card">
      <div style="margin: 20px 0; display: flex; gap: 10px; justify-content: center;">  
            <button class="btn-select" style="padding: 10px 20px; font-size: 0.9rem; background-color: #555;" 
                    onclick="location.href='{% url 'twobeats_worldcup:create_page' %}'">
                ?› ï¸??˜ë§Œ???”ë“œì»?ë§Œë“¤ê¸?
            </button>
            
            <button class="btn-select" style="padding: 10px 20px; font-size: 0.9rem; background-color: #555;" 
                    onclick="location.href='{% url 'twobeats_worldcup:ranking' %}'">
                ?† ?„ì²´ ??‚¹ ë³´ê¸°
            </button>
        </div>
    {% if is_custom %}
      <!-- ì»¤ìŠ¤?€ ?”ë“œì»?-->
      <div class="custom-title">{{ custom_wc.title }}</div>
      <div class="custom-creator">Created by {{ custom_wc.creator.username }}</div>

      <p style="color: rgba(255,255,255,0.7);">ì´?{{ custom_wc.musics.count }}ê³¡ì´ ì¤€ë¹„ë˜???ˆìŠµ?ˆë‹¤.</p>
      <button class="btn-start" onclick="startCustomGame('{{ custom_wc.access_code }}', {{ custom_wc.musics.count }})">
        ?”¥ ?„ì „?˜ê¸°
      </button>
    {% else %}
      <!-- ?¼ë°˜ ?”ë“œì»?-->
      <h2 style="color: rgba(255,255,255,0.9); margin-bottom: 30px;">ê²Œì„ ?¤ì •</h2>
      <div>
        <label>?¥ë¥´: </label>
        <select id="genre-select">
          <option value="all">?„ì²´ ?¥ë¥´</option>
          <option value="ballad">ë°œë¼??/option>
          <option value="dance">?„ìŠ¤</option>
          <option value="hiphop">?™í•©</option>
          <option value="rnb">R&B</option>
          <option value="indie">?¸ë””</option>
          <option value="ost">OST</option>
        </select>
      </div>
      <div>
        <label>ëª¨ë“œ: </label>
        <select id="mode-select">
          <option value="random">?œë¤ ë§¤ì¹­</option>
          <option value="rank">??‚¹ ë§¤ì¹­ (?¸ê¸°ê³?</option>
        </select>
      </div>
      <div>
        <label>?¼ìš´?? </label>
        <select id="round-select">
          <option value="32">32ê°?/option>
          <option value="16">16ê°?/option>
          <option value="8">8ê°?/option>
          <option value="4">4ê°?/option>
        </select>
      </div>
      <br>
      <button class="btn-start" onclick="startGame()">ê²Œì„ ?œì‘!</button>
    {% endif %}
    
  </div>

  <!-- ========================================
       ê²Œì„ ?”ë©´
       ======================================== -->
  <div id="game-screen" class="wc-card">
    <div class="status-bar" id="round-info">16ê°?- 1 / 8</div>

    <div class="versus-container">
      <!-- ?¼ìª½ ?„ë³´ -->
      <div class="candidate-wrapper">
        <div class="card" id="card-left" onclick="toggleAudio('left')">
          <div class="play-icon">??/div>
          <img id="img-left" src="" alt="cover">
          <div class="card-info">
            <h3 id="title-left">Title</h3>
            <p id="singer-left">Singer</p>
          </div>
        </div>
        <button class="btn-select" onclick="selectMusic('left')">?‘† ??ê³?? íƒ</button>
        <audio id="audio-left"></audio>
      </div>

      <!-- VS -->
      <div class="vs-text">VS</div>

      <!-- ?¤ë¥¸ìª??„ë³´ -->
      <div class="candidate-wrapper">
        <div class="card" id="card-right" onclick="toggleAudio('right')">
          <div class="play-icon">??/div>
          <img id="img-right" src="" alt="cover">
          <div class="card-info">
            <h3 id="title-right">Title</h3>
            <p id="singer-right">Singer</p>
          </div>
        </div>
        <button class="btn-select" onclick="selectMusic('right')">?‘† ??ê³?? íƒ</button>
        <audio id="audio-right"></audio>
      </div>
    </div>
    <p style="margin-top: 20px; color: rgba(255,255,255,0.4); font-size: 0.9rem;">???¨ë²” ì»¤ë²„ë¥??´ë¦­?˜ë©´ ë¯¸ë¦¬?£ê¸°ê°€ ?¬ìƒ?©ë‹ˆ??</p>
  </div>

  <!-- ========================================
       ê²°ê³¼ ?”ë©´
       ======================================== -->
  <div id="result-screen" class="wc-card">
    <h2>?† ìµœì¢… ?°ìŠ¹! ?†</h2>
    <div class="winner-card">
      <img id="img-winner" src="" alt="cover">
      <div>
        <h3 id="title-winner"></h3>
        <p id="singer-winner"></p>
      </div>
    </div>
    <button class="btn-start" onclick="location.reload()">?¤ì‹œ ?˜ê¸°</button>
  </div>
</div>

<!-- ========================================
     JavaScript - ê²Œì„ ë¡œì§
     ======================================== -->
<script>
    let candidates = [];
    let nextRound = [];
    let currentPairIndex = 0;
    let currentRoundName = 16;
    let gameHistory = [];
    let currentCustomCode = null;

    // ?¼ë°˜ ê²Œì„ ?œì‘
    async function startGame() {
        const genre = document.getElementById('genre-select').value;
        const sort = document.getElementById('mode-select').value;
        const count = parseInt(document.getElementById('round-select').value);
        currentCustomCode = null;

        await fetchAndStart(`/worldcup/candidates/?genre=${genre}&sort=${sort}&count=${count}`, count);
    }

    // ì»¤ìŠ¤?€ ê²Œì„ ?œì‘
    async function startCustomGame(code, realCount) {
        currentCustomCode = code;
        await fetchAndStart(`/worldcup/candidates/?custom_code=${code}&count=${realCount}`, realCount);
    }

    // ?°ì´??ê°€?¸ì???ê²Œì„ ?œì‘
    async function fetchAndStart(url, explicitCount) {
        try {
            const response = await fetch(url);
            const data = await response.json();

            if (!response.ok) {
                alert(data.error || "?¤ë¥˜ ë°œìƒ");
                return;
            }

            candidates = data.candidates;
            currentRoundName = explicitCount || candidates.length;
            nextRound = [];
            currentPairIndex = 0;
            gameHistory = [];

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';

            updateDisplay();

        } catch (error) {
            console.error(error);
            alert("?œë²„ ?°ê²° ?¤íŒ¨");
        }
    }

    // ?”ë©´ ?…ë°?´íŠ¸
    function updateDisplay() {
        stopAllAudio();

        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];

        if (!right) {
            nextRound.push(left);
            gameHistory.push({ music_id: left.id, rank: currentRoundName });
            endRound();
            return;
        }

        const defaultImg = "https://via.placeholder.com/300x300?text=No+Image";

        document.getElementById('img-left').src = left.thumbnail_url || defaultImg;
        document.getElementById('title-left').textContent = left.music_title;
        document.getElementById('singer-left').textContent = left.music_singer;
        document.getElementById('audio-left').src = left.file_url || "";

        document.getElementById('img-right').src = right.thumbnail_url || defaultImg;
        document.getElementById('title-right').textContent = right.music_title;
        document.getElementById('singer-right').textContent = right.music_singer;
        document.getElementById('audio-right').src = right.file_url || "";

        const totalMatches = Math.floor(candidates.length / 2);
        const currentMatch = (currentPairIndex / 2) + 1;

        let roundText = `${candidates.length}ê°?;
        if (candidates.length <= 2) roundText = "ê²°ìŠ¹??;
        else if (candidates.length <= 4) roundText = "4ê°?;
        else if (candidates.length <= 8) roundText = "8ê°?;
        else if (candidates.length <= 16) roundText = "16ê°?;

        document.getElementById('round-info').textContent = `${roundText} - ${currentMatch} / ${totalMatches}`;
    }

    // ?¤ë””??? ê?
    function toggleAudio(side) {
        const targetAudio = document.getElementById(`audio-${side}`);
        const otherAudio = document.getElementById(`audio-${side === 'left' ? 'right' : 'left'}`);
        const targetCard = document.getElementById(`card-${side}`);
        const otherCard = document.getElementById(`card-${side === 'left' ? 'right' : 'left'}`);

        if (targetAudio.paused) {
            otherAudio.pause();
            otherAudio.currentTime = 0;
            otherCard.classList.remove('playing-card');

            targetAudio.play().catch(e => console.log("?¬ìƒ ?¤íŒ¨:", e));
            targetCard.classList.add('playing-card');
        } else {
            targetAudio.pause();
            targetCard.classList.remove('playing-card');
        }
    }

    // ëª¨ë“  ?¤ë””???•ì?
    function stopAllAudio() {
        document.querySelectorAll('audio').forEach(a => {
            a.pause();
            a.currentTime = 0;
        });
        document.querySelectorAll('.card').forEach(c => {
            c.classList.remove('playing-card');
        });
    }

    // ?Œì•… ? íƒ
    function selectMusic(side) {
        stopAllAudio();

        const left = candidates[currentPairIndex];
        const right = candidates[currentPairIndex + 1];

        let winner, loser;
        if (side === 'left') {
            winner = left;
            loser = right;
        } else {
            winner = right;
            loser = left;
        }

        nextRound.push(winner);

        const rank = (candidates.length <= 2) ? 2 : candidates.length;
        gameHistory.push({ music_id: loser.id, rank: rank });

        currentPairIndex += 2;

        if (currentPairIndex >= candidates.length) {
            endRound();
        } else {
            updateDisplay();
        }
    }

    // ?¼ìš´??ì¢…ë£Œ
    function endRound() {
        if (candidates.length <= 2) {
            const finalWinner = nextRound[0];
            gameHistory.push({ music_id: finalWinner.id, rank: 1 });
            sendResultToServer(finalWinner);
        } else {
            candidates = nextRound;
            nextRound = [];
            currentPairIndex = 0;
            updateDisplay();
        }
    }

    // ê²°ê³¼ ?œë²„ ?„ì†¡
    async function sendResultToServer(winner) {
        try {
            const user_uid = "{% if user.is_authenticated %}{{ user.pk }}{% else %}{% endif %}";
            const final_uid = user_uid ? user_uid : null;

            const response = await fetch('/worldcup/save/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_uid: final_uid,
                    total_rounds: 16,
                    results: gameHistory,
                    custom_code: currentCustomCode
                })
            });

            const data = await response.json();
            if (response.ok) {
                window.location.href = `/worldcup/result/${data.game_id}/`;
            } else {
                alert("?€???¤íŒ¨: " + JSON.stringify(data));
            }
        } catch (e) {
            console.error("?€??ì¤??ëŸ¬", e);
            alert("?œë²„ ?µì‹  ?¤ë¥˜");
        }
    }
</script>
{% endblock %}

